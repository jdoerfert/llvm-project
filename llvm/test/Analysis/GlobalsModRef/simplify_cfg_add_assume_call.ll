; NOTE: Assertions have been autogenerated by utils/update_test_checks.py UTC_ARGS: --check-attributes --check-globals --version 2
; RUN: opt < %s -passes="require<globals-aa>,simplifycfg,function-attrs" -S | FileCheck %s

; Simplify CFG will add a call to llvm.assume which we need to model in the cached globals-aa result.
; Make sure we do not set memory(none) but memory(inaccessiblemem: readwrite), or avoid emitting the assume call.

; See https://github.com/llvm/llvm-project/issues/63925

define internal void @foo(ptr %p) {
; CHECK: Function Attrs: mustprogress nofree nosync nounwind willreturn memory(inaccessiblemem: readwrite)
; CHECK-LABEL: define internal void @foo
; CHECK-SAME: (ptr readnone [[P:%.*]]) #[[ATTR0:[0-9]+]] {
; CHECK-NEXT:  ok:
; CHECK-NEXT:    [[C:%.*]] = icmp eq ptr [[P]], null
; CHECK-NEXT:    [[TMP0:%.*]] = xor i1 [[C]], true
; CHECK-NEXT:    call void @llvm.assume(i1 [[TMP0]])
; CHECK-NEXT:    ret void
;
  %c = icmp eq ptr %p, null
  br i1 %c, label %err, label %ok
err:
  unreachable
ok:
  ret void
}

define internal void @bar() {
; CHECK: Function Attrs: mustprogress willreturn memory(inaccessiblemem: readwrite)
; CHECK-LABEL: define internal void @bar
; CHECK-SAME: () #[[ATTR1:[0-9]+]] {
; CHECK-NEXT:    call void @foo()
; CHECK-NEXT:    ret void
;
  call void @foo()
  ret void
}

define internal void @baz() {
; CHECK: Function Attrs: mustprogress willreturn memory(inaccessiblemem: readwrite)
; CHECK-LABEL: define internal void @baz
; CHECK-SAME: () #[[ATTR1]] {
; CHECK-NEXT:    call void @bar()
; CHECK-NEXT:    ret void
;
  call void @bar()
  ret void
}

define void @extern() {
; CHECK: Function Attrs: mustprogress willreturn memory(inaccessiblemem: readwrite)
; CHECK-LABEL: define void @extern
; CHECK-SAME: () #[[ATTR1]] {
; CHECK-NEXT:    call void @baz()
; CHECK-NEXT:    ret void
;
  call void @baz()
  ret void
}

;.
; CHECK: attributes #[[ATTR0]] = { mustprogress nofree nosync nounwind willreturn memory(inaccessiblemem: readwrite) }
; CHECK: attributes #[[ATTR1]] = { mustprogress willreturn memory(inaccessiblemem: readwrite) }
; CHECK: attributes #[[ATTR2:[0-9]+]] = { nocallback nofree nosync nounwind willreturn memory(inaccessiblemem: readwrite) }
;.
