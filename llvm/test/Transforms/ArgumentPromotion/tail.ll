; NOTE: Assertions have been autogenerated by utils/update_test_checks.py
; RUN: opt %s -argpromotion -sroa -S -o - | FileCheck %s --check-prefixes=ALL,ARGPROMOTION
; RUN: opt %s -passes='argpromotion,function(sroa)' -S -o - | FileCheck %s --check-prefixes=ALL,ARGPROMOTION
; RUN: opt -S -passes='attributor,function(sroa)' -aa-pipeline='basic-aa' -attributor-disable=false -attributor-max-iterations-verify -attributor-max-iterations=1 < %s | FileCheck %s --check-prefixes=ALL,ATTRIBUTOR
; PR14710

target datalayout = "e-m:e-i64:64-f80:128-n8:16:32:64-S128"

%pair = type { i32, i32 }

declare i8* @foo(%pair*)

define internal void @bar(%pair* byval %Data) {
; ARGPROMOTION-LABEL: define {{[^@]+}}@bar
; ARGPROMOTION-SAME: (i32 [[DATA_0:%.*]], i32 [[DATA_1:%.*]])
; ARGPROMOTION-NEXT:    [[DATA:%.*]] = alloca [[PAIR:%.*]]
; ARGPROMOTION-NEXT:    [[DOT0:%.*]] = getelementptr [[PAIR]], %pair* [[DATA]], i32 0, i32 0
; ARGPROMOTION-NEXT:    store i32 [[DATA_0]], i32* [[DOT0]]
; ARGPROMOTION-NEXT:    [[DOT1:%.*]] = getelementptr [[PAIR]], %pair* [[DATA]], i32 0, i32 1
; ARGPROMOTION-NEXT:    store i32 [[DATA_1]], i32* [[DOT1]]
; ARGPROMOTION-NEXT:    [[TMP1:%.*]] = call i8* @foo(%pair* [[DATA]])
; ARGPROMOTION-NEXT:    ret void
;
; ATTRIBUTOR-LABEL: define {{[^@]+}}@bar
; ATTRIBUTOR-SAME: (i32 [[TMP0:%.*]], i32 [[TMP1:%.*]])
; ATTRIBUTOR-NEXT:    [[DATA_PRIV:%.*]] = alloca [[PAIR:%.*]]
; ATTRIBUTOR-NEXT:    [[DATA_PRIV_CAST:%.*]] = bitcast %pair* [[DATA_PRIV]] to i32*
; ATTRIBUTOR-NEXT:    store i32 [[TMP0]], i32* [[DATA_PRIV_CAST]]
; ATTRIBUTOR-NEXT:    [[DATA_PRIV_0_1:%.*]] = getelementptr [[PAIR]], %pair* [[DATA_PRIV]], i32 0, i32 1
; ATTRIBUTOR-NEXT:    store i32 [[TMP1]], i32* [[DATA_PRIV_0_1]]
; ATTRIBUTOR-NEXT:    [[TMP3:%.*]] = call i8* @foo(%pair* nonnull [[DATA_PRIV]])
; ATTRIBUTOR-NEXT:    ret void
;
  tail call i8* @foo(%pair* %Data)
  ret void
}

define void @zed(%pair* byval %Data) {
; ARGPROMOTION-LABEL: define {{[^@]+}}@zed
; ARGPROMOTION-SAME: (%pair* byval [[DATA:%.*]])
; ARGPROMOTION-NEXT:    [[DATA_0:%.*]] = getelementptr [[PAIR:%.*]], %pair* [[DATA]], i32 0, i32 0
; ARGPROMOTION-NEXT:    [[DATA_0_VAL:%.*]] = load i32, i32* [[DATA_0]]
; ARGPROMOTION-NEXT:    [[DATA_1:%.*]] = getelementptr [[PAIR]], %pair* [[DATA]], i32 0, i32 1
; ARGPROMOTION-NEXT:    [[DATA_1_VAL:%.*]] = load i32, i32* [[DATA_1]]
; ARGPROMOTION-NEXT:    call void @bar(i32 [[DATA_0_VAL]], i32 [[DATA_1_VAL]])
; ARGPROMOTION-NEXT:    ret void
;
; ATTRIBUTOR-LABEL: define {{[^@]+}}@zed
; ATTRIBUTOR-SAME: (%pair* nonnull byval [[DATA:%.*]])
; ATTRIBUTOR-NEXT:    [[DATA_CAST:%.*]] = bitcast %pair* [[DATA]] to i32*
; ATTRIBUTOR-NEXT:    [[TMP1:%.*]] = load i32, i32* [[DATA_CAST]]
; ATTRIBUTOR-NEXT:    [[DATA_0_1:%.*]] = getelementptr [[PAIR:%.*]], %pair* [[DATA]], i32 0, i32 1
; ATTRIBUTOR-NEXT:    [[TMP2:%.*]] = load i32, i32* [[DATA_0_1]]
; ATTRIBUTOR-NEXT:    call void @bar(i32 [[TMP1]], i32 [[TMP2]])
; ATTRIBUTOR-NEXT:    ret void
;
  call void @bar(%pair* byval %Data)
  ret void
}
