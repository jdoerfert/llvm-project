; NOTE: Assertions have been autogenerated by utils/update_test_checks.py
; RUN: opt < %s -argpromotion -S | FileCheck %s --check-prefixes=ALL,ARGPROMOTION
; RUN: opt -S -passes=attributor -aa-pipeline='basic-aa' -attributor-disable=false -attributor-max-iterations-verify -attributor-max-iterations=2 < %s | FileCheck %s --check-prefixes=ALL,ATTRIBUTOR
; PR 32917

@b = common local_unnamed_addr global i32 0, align 4
@a = common local_unnamed_addr global i32 0, align 4

define i32 @fn2() local_unnamed_addr {
; ARGPROMOTION-LABEL: define {{[^@]+}}@fn2() local_unnamed_addr
; ARGPROMOTION-NEXT:    [[TMP1:%.*]] = load i32, i32* @b, align 4
; ARGPROMOTION-NEXT:    [[TMP2:%.*]] = sext i32 [[TMP1]] to i64
; ARGPROMOTION-NEXT:    [[TMP3:%.*]] = inttoptr i64 [[TMP2]] to i32*
; ARGPROMOTION-NEXT:    [[DOTIDX:%.*]] = getelementptr i32, i32* [[TMP3]], i64 -1
; ARGPROMOTION-NEXT:    [[DOTIDX_VAL:%.*]] = load i32, i32* [[DOTIDX]], align 4
; ARGPROMOTION-NEXT:    call fastcc void @fn1(i32 [[DOTIDX_VAL]])
; ARGPROMOTION-NEXT:    ret i32 undef
;
; ATTRIBUTOR-LABEL: define {{[^@]+}}@fn2() local_unnamed_addr
; ATTRIBUTOR-NEXT:    [[TMP1:%.*]] = load i32, i32* @b, align 4
; ATTRIBUTOR-NEXT:    [[TMP2:%.*]] = sext i32 [[TMP1]] to i64
; ATTRIBUTOR-NEXT:    [[TMP3:%.*]] = inttoptr i64 [[TMP2]] to i32*
; ATTRIBUTOR-NEXT:    call fastcc void @fn1(i32* [[TMP3]])
; ATTRIBUTOR-NEXT:    ret i32 undef
;
  %1 = load i32, i32* @b, align 4
  %2 = sext i32 %1 to i64
  %3 = inttoptr i64 %2 to i32*
  call fastcc void @fn1(i32* %3)
  ret i32 undef
}

define internal fastcc void @fn1(i32* nocapture readonly) unnamed_addr {
; ARGPROMOTION-LABEL: define {{[^@]+}}@fn1
; ARGPROMOTION-SAME: (i32 [[DOT18446744073709551615_VAL:%.*]]) unnamed_addr
; ARGPROMOTION-NEXT:    store i32 [[DOT18446744073709551615_VAL]], i32* @a, align 4
; ARGPROMOTION-NEXT:    ret void
;
; ATTRIBUTOR-LABEL: define {{[^@]+}}@fn1
; ATTRIBUTOR-SAME: (i32* nocapture readonly [[TMP0:%.*]]) unnamed_addr
; ATTRIBUTOR-NEXT:    [[TMP2:%.*]] = getelementptr inbounds i32, i32* [[TMP0]], i64 -1
; ATTRIBUTOR-NEXT:    [[TMP3:%.*]] = load i32, i32* [[TMP2]], align 4
; ATTRIBUTOR-NEXT:    store i32 [[TMP3]], i32* @a, align 4
; ATTRIBUTOR-NEXT:    ret void
;
  %2 = getelementptr inbounds i32, i32* %0, i64 -1
  %3 = load i32, i32* %2, align 4
  store i32 %3, i32* @a, align 4
  ret void
}
